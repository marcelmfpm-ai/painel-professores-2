<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel de Coordena√ß√£o de Curso</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root {
    --primary: #1e3a5f;
    --primary-light: #2d5a8e;
    --accent: #b8860b;
    --accent-light: #d4a017;
    --bg: #f0f4f8;
    --card-bg: #ffffff;
    --border: #d1dce8;
    --border-strong: #b0c4d8;
    --text: #1e293b;
    --text-muted: #64748b;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; min-height: 100vh; }

  .header-bar {
    background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8e 60%, #1e3a5f 100%);
    border-bottom: 3px solid var(--accent-light);
    padding: 14px 28px; display: flex; align-items: center; gap: 16px;
    box-shadow: 0 2px 12px rgba(30,58,95,0.25);
  }
  .header-bar .logo { width: 46px; height: 46px; background: var(--accent-light); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; color: #1e3a5f; flex-shrink: 0; }
  .header-bar h1 { font-size: 1.15rem; font-weight: 800; color: #fff; letter-spacing: 0.04em; }
  .header-bar p { font-size: 0.72rem; color: #93c5fd; letter-spacing: 0.1em; text-transform: uppercase; margin-top: 2px; }

  .upload-zone { border: 2px dashed var(--accent-light); background: #fffbf0; border-radius: 14px; padding: 48px 40px; text-align: center; cursor: pointer; transition: all 0.3s; }
  .upload-zone:hover { background: #fef3c7; border-color: var(--accent); }
  .upload-zone.drag-over { background: #fef3c7; border-color: #92400e; }

  .tab-btn { padding: 9px 22px; border-radius: 8px; border: 1.5px solid var(--border-strong); background: #fff; color: var(--text-muted); cursor: pointer; font-size: 0.84rem; font-weight: 700; transition: all 0.2s; display: flex; align-items: center; gap: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
  .tab-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 2px 8px rgba(30,58,95,0.25); }
  .tab-btn:hover:not(.active) { border-color: var(--primary-light); color: var(--primary); background: #f0f4f8; }

  .filter-bar { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 16px 18px; display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; box-shadow: 0 1px 6px rgba(30,58,95,0.07); }
  .filter-group { display: flex; flex-direction: column; gap: 5px; min-width: 155px; flex: 1; }
  .filter-group label { font-size: 0.68rem; color: var(--primary); font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; }
  .filter-group select, .filter-group input { background: #f8fafc; border: 1.5px solid var(--border); border-radius: 7px; color: var(--text); padding: 8px 10px; font-size: 0.84rem; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
  .filter-group select:focus, .filter-group input:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(45,90,142,0.1); }

  /* Toggle mostrar passados */
  .toggle-past-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 16px; border-radius: 8px;
    font-size: 0.8rem; font-weight: 700; cursor: pointer;
    border: 1.5px solid var(--border); background: #fff;
    color: var(--text-muted); transition: all 0.2s;
    white-space: nowrap;
  }
  .toggle-past-btn.showing-past {
    background: #fef9c3; border-color: #fbbf24; color: #92400e;
  }
  .toggle-past-btn .dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: #d1d5db; transition: background 0.2s;
    flex-shrink: 0;
  }
  .toggle-past-btn.showing-past .dot { background: #f59e0b; }

  /* Banner de datas passadas ocultas */
  .past-hidden-banner {
    display: flex; align-items: center; gap: 10px;
    background: #fffbeb; border: 1px solid #fde68a;
    border-radius: 9px; padding: 10px 16px;
    font-size: 0.79rem; color: #92400e; font-weight: 600;
    margin-bottom: 16px;
  }
  .past-hidden-banner button {
    margin-left: auto; padding: 4px 12px; border-radius: 6px;
    background: #fbbf24; border: none; color: #1e3a5f;
    font-size: 0.75rem; font-weight: 800; cursor: pointer;
    transition: background 0.2s;
  }
  .past-hidden-banner button:hover { background: #f59e0b; }

  /* Card de evento passado: levemente acinzentado */
  .aula-card.is-past { opacity: 0.65; }
  .aula-card.is-past .card-header { background: linear-gradient(135deg, #475569, #64748b); }

  .aula-card { background: var(--card-bg); border: 1.5px solid var(--border); border-radius: 14px; overflow: hidden; transition: transform 0.18s, box-shadow 0.18s; box-shadow: 0 2px 8px rgba(30,58,95,0.07); }
  .aula-card:hover { transform: translateY(-3px); box-shadow: 0 8px 28px rgba(30,58,95,0.14); }
  .aula-card.has-conflict { border-color: #fca5a5; box-shadow: 0 0 0 2px rgba(239,68,68,0.15); }
  .aula-card.has-overtime { border-color: #fcd34d; }

  .card-header { padding: 14px 16px; background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8e 100%); border-bottom: 2px solid var(--accent-light); position: relative; }
  .card-header .aula-code { font-size: 1.15rem; font-weight: 800; color: #fbbf24; letter-spacing: 0.05em; }
  .card-header .aula-name { font-size: 0.73rem; color: #93c5fd; margin-top: 2px; }
  .card-header .sala { font-size: 0.85rem; color: #e2e8f0; font-weight: 600; margin-top: 5px; }
  .card-header .horario { font-size: 0.82rem; color: #bfdbfe; margin-top: 3px; font-weight: 600; }
  .card-header .data-badge { position: absolute; top: 12px; right: 12px; background: rgba(251,191,36,0.18); border: 1px solid rgba(251,191,36,0.5); border-radius: 6px; padding: 3px 9px; font-size: 0.73rem; color: #fbbf24; font-weight: 700; }
  .card-header .past-tag { display: inline-block; margin-top: 4px; padding: 2px 8px; background: rgba(255,255,255,0.15); border-radius: 4px; font-size: 0.68rem; color: #cbd5e1; font-weight: 700; }

  .card-body { padding: 12px 16px; }

  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 9px; border-radius: 20px; font-size: 0.67rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.04em; white-space: nowrap; }
  .badge-professor { background: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; }
  .badge-monitor { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
  .badge-aproximado { background: #ede9fe; color: #6d28d9; border: 1px solid #ddd6fe; }
  .badge-ocorrencia { background: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
  .badge-coordenador { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
  .badge-motorista { background: #cffafe; color: #0e7490; border: 1px solid #a5f3fc; }
  .badge-aeroporto { background: #fce7f3; color: #9d174d; border: 1px solid #fbcfe8; }
  .badge-volante { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
  .badge-monitor-sala { background: #ccfbf1; color: #0f766e; border: 1px solid #99f6e4; }

  .person-row { display: flex; align-items: center; gap: 8px; padding: 5px 4px; border-bottom: 1px solid #f1f5f9; }
  .person-row:last-child { border-bottom: none; }
  .person-row.conflict-person { background: #fff5f5; border-radius: 5px; padding: 5px 7px; }
  .person-name { font-size: 0.82rem; color: var(--text); font-weight: 500; flex: 1; }

  .alert-bar { display: flex; align-items: center; gap: 8px; padding: 7px 12px; border-radius: 7px; margin-bottom: 8px; font-size: 0.77rem; font-weight: 700; }
  .alert-conflict { background: #fef2f2; border: 1px solid #fecaca; color: #b91c1c; }
  .alert-overtime { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }

  .card-footer { padding: 8px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
  .btn-export { font-size: 0.72rem; font-weight: 700; padding: 5px 12px; border-radius: 6px; background: var(--primary); border: none; color: #fff; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px; box-shadow: 0 1px 4px rgba(30,58,95,0.2); }
  .btn-export:hover { background: var(--primary-light); }
  .count-badge { font-size: 0.73rem; color: var(--text-muted); font-weight: 600; }

  .grade-container { overflow-x: auto; border-radius: 12px; box-shadow: 0 2px 8px rgba(30,58,95,0.08); }
  .grade-table { border-collapse: separate; border-spacing: 4px; min-width: 860px; width: 100%; background: #e8eef5; padding: 4px; border-radius: 12px; }
  .grade-table th { background: var(--primary); padding: 11px 14px; font-size: 0.77rem; font-weight: 800; text-align: center; color: #fbbf24; border-radius: 7px; letter-spacing: 0.05em; text-transform: uppercase; white-space: nowrap; }
  .grade-table th.is-past { background: #64748b; color: #cbd5e1; }
  .grade-table th.is-today { background: #065f46; color: #6ee7b7; }
  .grade-table td { background: #fff; border: 1.5px solid var(--border); border-radius: 8px; padding: 7px; vertical-align: top; min-height: 60px; min-width: 130px; }
  .grade-table td.is-past-col { background: #f8fafc; opacity: 0.7; }
  .grade-cell-event { background: linear-gradient(135deg, #dbeafe, #eff6ff); border: 1.5px solid #bfdbfe; border-radius: 7px; padding: 7px 9px; margin-bottom: 5px; cursor: pointer; transition: all 0.18s; }
  .grade-cell-event:hover { border-color: var(--primary-light); box-shadow: 0 2px 8px rgba(30,58,95,0.12); }
  .grade-cell-event.conflict { border-color: #fca5a5; background: linear-gradient(135deg, #fee2e2, #fff5f5); }
  .grade-cell-event.overtime { border-color: #fde68a; background: linear-gradient(135deg, #fef9c3, #fffde7); }
  .grade-cell-event.is-past { opacity: 0.6; }
  .grade-event-code { font-size: 0.75rem; font-weight: 800; color: #1e3a5f; }
  .grade-event-horario { font-size: 0.68rem; color: #2d5a8e; font-weight: 700; margin-top: 1px; }
  .grade-event-sala { font-size: 0.68rem; color: #64748b; margin-top: 1px; }
  .grade-event-count { font-size: 0.65rem; color: #94a3b8; margin-top: 3px; }
  .grade-time-col { text-align: center; font-size: 0.76rem; color: var(--text-muted); font-weight: 700; padding: 8px 10px; background: #f8fafc; border-radius: 7px; border: 1.5px solid var(--border); white-space: nowrap; }

  .stats-bar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
  .stat-card { background: #fff; border: 1.5px solid var(--border); border-radius: 12px; padding: 14px 20px; flex: 1; min-width: 120px; box-shadow: 0 1px 5px rgba(30,58,95,0.06); transition: box-shadow 0.2s; }
  .stat-card:hover { box-shadow: 0 4px 12px rgba(30,58,95,0.1); }
  .stat-card .val { font-size: 1.9rem; font-weight: 800; color: var(--primary); }
  .stat-card .lbl { font-size: 0.69rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 3px; }

  .conflict-summary { background: #fef2f2; border: 1.5px solid #fecaca; border-radius: 10px; padding: 14px 18px; margin-bottom: 14px; }
  .overtime-summary { background: #fffbeb; border: 1.5px solid #fde68a; border-radius: 10px; padding: 14px 18px; margin-bottom: 14px; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }

  .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.55); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(3px); }
  .modal-box { background: #fff; border: 1.5px solid var(--border); border-radius: 16px; max-width: 520px; width: 100%; max-height: 82vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(15,23,42,0.3); }
  .modal-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: linear-gradient(135deg,#1e3a5f,#2d5a8e); border-radius: 16px 16px 0 0; }
  .modal-header span { font-weight: 800; color: #fbbf24; font-size: 0.95rem; }
  .modal-close { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 1rem; cursor: pointer; padding: 4px 9px; border-radius: 6px; transition: background 0.2s; }
  .modal-close:hover { background: rgba(255,255,255,0.3); }
  .modal-body { padding: 20px; }

  .btn-grade-export { display: flex; align-items: center; gap: 7px; padding: 9px 20px; border-radius: 8px; background: var(--primary); border: none; color: #fff; cursor: pointer; font-size: 0.84rem; font-weight: 700; box-shadow: 0 2px 8px rgba(30,58,95,0.25); transition: all 0.2s; }
  .btn-grade-export:hover { background: var(--primary-light); }
  .btn-grade-export:disabled { opacity: 0.6; cursor: not-allowed; }

  @media (max-width: 640px) { .filter-bar { flex-direction: column; } .filter-group { min-width: 100%; } }
</style>
</head>
<body>

<div class="header-bar">
  <div class="logo">‚öñ</div>
  <div>
    <h1>PAINEL DE COORDENA√á√ÉO DE CURSO</h1>
    <p>Sistema de Gerenciamento de Escalas ¬∑ Academia Nacional de Pol√≠cia</p>
  </div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:12px;">
    <span id="todayLabel" style="font-size:0.72rem;color:#bfdbfe;font-weight:600;"></span>
    <span id="statusBadge" style="font-size:0.73rem;padding:5px 12px;border-radius:20px;background:rgba(255,255,255,0.12);color:#93c5fd;font-weight:600;">Sem dados carregados</span>
  </div>
</div>

<div style="padding:24px;max-width:1400px;margin:0 auto;">

  <!-- UPLOAD -->
  <div id="uploadSection">
    <div style="max-width:620px;margin:40px auto;">
      <div class="upload-zone" id="dropZone" onclick="document.getElementById('csvFileInput').click()">
        <div style="font-size:3.5rem;margin-bottom:14px;">üìÇ</div>
        <div style="font-size:1.1rem;font-weight:800;color:#1e3a5f;margin-bottom:6px;">Carregar Arquivo CSV</div>
        <div style="font-size:0.83rem;color:#64748b;margin-bottom:18px;">Arraste e solte aqui ou clique para selecionar</div>
        <div style="font-size:0.72rem;color:#94a3b8;margin-bottom:20px;background:#fff;padding:8px 14px;border-radius:8px;display:inline-block;border:1px solid #e2e8f0;">
          Formato: <code>Data;Hor√°rio;Aula;Funcao;Nome;TURMA</code>
        </div><br>
        <button style="background:#1e3a5f;color:#fbbf24;font-weight:800;font-size:0.85rem;padding:11px 26px;border:none;border-radius:9px;cursor:pointer;">
          üìÅ Selecionar Arquivo CSV
        </button>
      </div>
      <input type="file" id="csvFileInput" accept=".csv,.txt" style="display:none">
      <div style="margin-top:20px;background:#fff;border:1.5px solid var(--border);border-radius:12px;padding:18px;">
        <div style="font-size:0.73rem;color:var(--primary);font-weight:800;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.1em;">‚Äî ou cole o conte√∫do CSV diretamente ‚Äî</div>
        <textarea id="csvPasteArea" style="width:100%;height:110px;background:#f8fafc;border:1.5px solid var(--border);border-radius:8px;color:var(--text);padding:10px;font-size:0.78rem;font-family:monospace;resize:vertical;outline:none;" placeholder="Cole aqui o conte√∫do do CSV..."></textarea>
        <button onclick="processPastedCSV()" style="margin-top:10px;background:#1e3a5f;border:none;color:#fbbf24;font-weight:800;font-size:0.82rem;padding:9px 22px;border-radius:7px;cursor:pointer;">‚ö° Processar CSV</button>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashSection" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
      <div style="display:flex;gap:8px;">
        <button class="tab-btn active" id="tabCards" onclick="switchView('cards')">üÉè Cards</button>
        <button class="tab-btn" id="tabGrade" onclick="switchView('grade')">üìÖ Grade Semanal</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span id="loadedFileLabel" style="font-size:0.75rem;color:var(--text-muted);font-weight:600;"></span>
        <button onclick="resetDashboard()" style="font-size:0.75rem;padding:7px 15px;border-radius:7px;background:#fff;border:1.5px solid var(--border);color:var(--text-muted);cursor:pointer;font-weight:600;">üîÑ Novo CSV</button>
      </div>
    </div>

    <div class="stats-bar" id="statsBar"></div>
    <div id="alertsSection"></div>

    <!-- BANNER datas passadas ocultas -->
    <div id="pastBanner" style="display:none;" class="past-hidden-banner">
      <span>üìÖ</span>
      <span id="pastBannerText"></span>
      <button onclick="toggleShowPast(true)">Exibir datas anteriores</button>
    </div>

    <!-- FILTROS -->
    <div class="filter-bar" style="margin-bottom:22px;">
      <div class="filter-group" style="min-width:140px;">
        <label>üìÖ Data</label>
        <select id="filtData" onchange="applyFilters()"><option value="">Todas</option></select>
      </div>
      <div class="filter-group" style="min-width:155px;">
        <label>üîë Aula</label>
        <select id="filtAula" onchange="applyFilters()"><option value="">Todas</option></select>
      </div>
      <div class="filter-group" style="min-width:150px;">
        <label>üè´ Turma</label>
        <select id="filtSala" onchange="applyFilters()"><option value="">Todas</option></select>
      </div>
      <div class="filter-group" style="flex:2;min-width:200px;">
        <label>üîç Buscar por Nome</label>
        <input type="text" id="filtNome" placeholder="Digite o nome..." oninput="applyFilters()">
      </div>
      <div class="filter-group" style="min-width:90px;justify-content:flex-end;">
        <label style="opacity:0;">x</label>
        <button onclick="clearFilters()" style="padding:8px 14px;background:#f8fafc;border:1.5px solid var(--border);border-radius:7px;color:var(--text-muted);cursor:pointer;font-size:0.8rem;font-weight:600;">‚úï Limpar</button>
      </div>
      <!-- Toggle mostrar passados -->
      <div class="filter-group" style="min-width:190px;justify-content:flex-end;">
        <label style="opacity:0;">x</label>
        <button class="toggle-past-btn" id="togglePastBtn" onclick="toggleShowPast()">
          <span class="dot"></span>
          <span id="togglePastLabel">Mostrar datas anteriores</span>
        </button>
      </div>
    </div>

    <!-- CARDS VIEW -->
    <div id="viewCards">
      <div id="cardsContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;"></div>
      <div id="emptyCards" class="empty-state" style="display:none;">
        <div style="font-size:3rem;margin-bottom:14px;">üîé</div>
        <div style="font-size:1rem;font-weight:700;color:var(--text);margin-bottom:6px;">Nenhum resultado encontrado</div>
        <div style="font-size:0.83rem;">Ajuste os filtros para visualizar os dados.</div>
      </div>
    </div>

    <!-- GRADE VIEW -->
    <div id="viewGrade" style="display:none;">
      <div style="display:flex;justify-content:flex-end;margin-bottom:14px;">
        <button class="btn-grade-export" id="btnGradeExport" onclick="exportGrade()">üì∑ Exportar Grade como Imagem</button>
      </div>
      <div class="grade-container" id="gradeWrapper">
        <table class="grade-table" id="gradeTable"></table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modalOverlay" class="modal-overlay" style="display:none;" onclick="closeModal(event)">
  <div class="modal-box">
    <div class="modal-header">
      <span id="modalTitle"></span>
      <button class="modal-close" onclick="closeModalDirect()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
const AULA_NAMES = {
  'M1.1':  'TE√ìRICA PS',
  'M1.2P': 'PLANT√ÉO',
  'M1.2S': 'SOBREAVISO',
  'M3.3':  'VIGIL√ÇNCIA AEROPORTO'
};
const AULA_DURATIONS = { 'M1.1': 100, 'M1.2P': 100, 'M1.2S': 100, 'M3.3': 300 };

let allEvents = [];
let filteredEvents = [];
let currentView = 'cards';
let conflictMap = {};
let overtimeMap = {};
let showPast = false; // controle principal de exibi√ß√£o de passados

// ===================== DATA ATUAL =====================
function getTodayMidnight() {
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate());
}

function parseDateToObj(str) {
  // "DD/MM/YYYY" -> Date meia-noite
  const p = str.split('/');
  if (p.length !== 3) return null;
  return new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0]));
}

function isDatePast(dateStr) {
  const d = parseDateToObj(dateStr);
  if (!d) return false;
  return d < getTodayMidnight();
}

function isDateToday(dateStr) {
  const d = parseDateToObj(dateStr);
  if (!d) return false;
  const today = getTodayMidnight();
  return d.getTime() === today.getTime();
}

// Mostra a data atual no header
function initTodayLabel() {
  const today = new Date();
  const opts = { weekday:'long', day:'2-digit', month:'long', year:'numeric' };
  document.getElementById('todayLabel').textContent =
    'üìÖ Hoje: ' + today.toLocaleDateString('pt-BR', opts);
}
initTodayLabel();

// ===================== CSV PROCESSING =====================
function processCSV(text) {
  const parsed = Papa.parse(text.trim(), {
    delimiter: ';', skipEmptyLines: true, header: true,
    trimHeaders: true, transform: val => val.trim()
  });

  const rows = parsed.data.filter(r => r.Data && r.Aula && r.Nome && r.Nome.trim());
  const sampleRow = rows[0] || {};
  const colHorario = Object.keys(sampleRow).find(k =>
    k.toLowerCase().includes('coluna') || k.toLowerCase().includes('hor√°rio') || k.toLowerCase().includes('horario')
  ) || 'Coluna1';
  const colSala = Object.keys(sampleRow).find(k =>
    k.toLowerCase().includes('turma') || k.toLowerCase().includes('sala')
  ) || 'TURMA';

  const eventMap = {};
  rows.forEach(r => {
    if (!r.Data || !r.Aula || !r.Nome) return;
    const key = `${r.Data}||${r.Aula}||${(r[colSala]||'').trim()}`;
    if (!eventMap[key]) {
      eventMap[key] = { data: r.Data.trim(), aula: r.Aula.trim(), sala: (r[colSala]||'').trim(), horarios: [], equipe: [] };
    }
    const h = (r[colHorario]||'').trim();
    if (h && !eventMap[key].horarios.includes(h)) eventMap[key].horarios.push(h);
    eventMap[key].equipe.push({ nome: r.Nome.trim(), funcao: (r.Funcao||r['Fun√ß√£o']||'').trim() });
  });

  allEvents = Object.values(eventMap).map(ev => {
    const { start, end } = resolveHorario(ev.horarios, ev.aula);
    return {
      ...ev,
      horarioDisplay: buildHorarioDisplay(start, end),
      horarioStart: start,
      horarioEnd: end,
      durationMin: (start !== null && end !== null) ? end - start : 0,
      isPast: isDatePast(ev.data),
      isToday: isDateToday(ev.data)
    };
  });

  computeConflicts();
  computeOvertime();
  buildFilters();
  buildStats();
  buildAlerts();
  updatePastBanner();
  applyFilters();

  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('dashSection').style.display = 'block';
  document.getElementById('statusBadge').textContent = `‚úÖ ${allEvents.length} eventos carregados`;
  document.getElementById('statusBadge').style.cssText += ';color:#86efac;background:rgba(22,163,74,0.2);';
}

// ===================== TOGGLE SHOW PAST =====================
function toggleShowPast(forceShow) {
  showPast = forceShow !== undefined ? forceShow : !showPast;

  const btn = document.getElementById('togglePastBtn');
  const lbl = document.getElementById('togglePastLabel');

  if (showPast) {
    btn.classList.add('showing-past');
    lbl.textContent = 'Ocultar datas anteriores';
    document.getElementById('pastBanner').style.display = 'none';
  } else {
    btn.classList.remove('showing-past');
    lbl.textContent = 'Mostrar datas anteriores';
    updatePastBanner();
  }
  applyFilters();
}

function updatePastBanner() {
  const pastCount = allEvents.filter(e => e.isPast).length;
  const pastDates = [...new Set(allEvents.filter(e => e.isPast).map(e => e.data))];
  const banner = document.getElementById('pastBanner');
  if (pastCount > 0 && !showPast) {
    banner.style.display = 'flex';
    document.getElementById('pastBannerText').textContent =
      `${pastDates.length} data${pastDates.length>1?'s':''}  anterior${pastDates.length>1?'es':''} ocult${pastDates.length>1?'as':'a'} (${pastDates.join(', ')}) ‚Äî ${pastCount} evento${pastCount>1?'s':''} no total`;
  } else {
    banner.style.display = 'none';
  }
}

// ===================== HOR√ÅRIO =====================
function parseTime(str) {
  if (!str) return null;
  const m = str.match(/(\d{1,2}):(\d{2})/);
  if (!m) return null;
  return parseInt(m[1])*60 + parseInt(m[2]);
}
function formatMin(min) {
  if (min === null || min === undefined) return '--:--';
  return `${String(Math.floor(min/60)).padStart(2,'0')}:${String(min%60).padStart(2,'0')}`;
}
function resolveHorario(horarios, aulaCode) {
  let starts = [], ends = [];
  horarios.forEach(h => {
    const rangeMatch = h.match(/(\d{1,2}:\d{2})\s*[-‚Äì]\s*(\d{1,2}:\d{2})/);
    if (rangeMatch) {
      const s = parseTime(rangeMatch[1]), e = parseTime(rangeMatch[2]);
      if (s !== null) starts.push(s);
      if (e !== null) ends.push(e);
    } else {
      const s = parseTime(h);
      if (s !== null) { starts.push(s); ends.push(s + (AULA_DURATIONS[aulaCode] || 100)); }
    }
  });
  if (starts.length === 0) return { start: null, end: null };
  return { start: Math.min(...starts), end: Math.max(...ends) };
}
function buildHorarioDisplay(start, end) {
  if (start === null) return 'Hor√°rio n√£o informado';
  if (end === null) return formatMin(start);
  return `${formatMin(start)} - ${formatMin(end)}`;
}

// ===================== CONFLICT & OVERTIME =====================
function computeConflicts() {
  conflictMap = {};
  const personEvents = {};
  allEvents.forEach((ev, idx) => {
    ev.equipe.forEach(m => {
      const key = m.nome.toUpperCase();
      if (!personEvents[key]) personEvents[key] = [];
      personEvents[key].push({ idx, data: ev.data, start: ev.horarioStart, end: ev.horarioEnd, sala: ev.sala, aula: ev.aula });
    });
  });
  allEvents.forEach(ev => ev._conflicts = []);
  Object.entries(personEvents).forEach(([nome, evList]) => {
    for (let i = 0; i < evList.length; i++) {
      for (let j = i+1; j < evList.length; j++) {
        const a = evList[i], b = evList[j];
        if (a.data !== b.data || a.start === null || b.start === null) continue;
        if (a.start < b.end && a.end > b.start) {
          if (!conflictMap[nome]) conflictMap[nome] = [];
          const info = `${a.aula}/${a.sala} e ${b.aula}/${b.sala} em ${a.data}`;
          if (!conflictMap[nome].includes(info)) conflictMap[nome].push(info);
          allEvents[a.idx]._conflicts.push(nome);
          allEvents[b.idx]._conflicts.push(nome);
        }
      }
    }
  });
  allEvents.forEach(ev => ev._hasConflict = ev._conflicts.length > 0);
}
function computeOvertime() {
  overtimeMap = {};
  const personDayMin = {};
  allEvents.forEach(ev => {
    ev.equipe.forEach(m => {
      const key = `${m.nome.toUpperCase()}||${ev.data}`;
      if (!personDayMin[key]) personDayMin[key] = 0;
      personDayMin[key] += ev.durationMin;
    });
  });
  Object.entries(personDayMin).forEach(([key, total]) => {
    const [nome, data] = key.split('||');
    if (total > 480) {
      if (!overtimeMap[nome]) overtimeMap[nome] = [];
      overtimeMap[nome].push({ data, totalMin: total });
    }
  });
  allEvents.forEach(ev => {
    ev._overtime = ev.equipe.filter(m => overtimeMap[m.nome.toUpperCase()] && overtimeMap[m.nome.toUpperCase()].some(o => o.data === ev.data)).map(m => m.nome.toUpperCase());
    ev._hasOvertime = ev._overtime.length > 0;
  });
}

// ===================== FILTERS =====================
function buildFilters() {
  const datas = [...new Set(allEvents.map(e => e.data))].sort((a,b) => parseDate(a)-parseDate(b));
  const aulas = [...new Set(allEvents.map(e => e.aula))].sort();
  const salas = [...new Set(allEvents.map(e => e.sala))].sort();
  fillSelect('filtData', datas);
  fillSelect('filtAula', aulas);
  fillSelect('filtSala', salas);
}
function parseDate(d) {
  if (!d) return 0;
  const p = d.split('/');
  return parseInt(p[2])*10000 + parseInt(p[1])*100 + parseInt(p[0]);
}
function fillSelect(id, values) {
  const sel = document.getElementById(id);
  const cur = sel.value;
  while (sel.options.length > 1) sel.remove(1);
  values.forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  if (values.includes(cur)) sel.value = cur;
}

function applyFilters() {
  const fData = document.getElementById('filtData').value;
  const fAula = document.getElementById('filtAula').value;
  const fSala = document.getElementById('filtSala').value;
  const fNome = document.getElementById('filtNome').value.trim().toLowerCase();

  // Se algum filtro de data ativo ou nome, ignorar a oculta√ß√£o de passados
  const hasActiveFilter = fData || fAula || fSala || fNome;

  filteredEvents = allEvents.filter(ev => {
    // Ocultar passados a menos que: showPast=true OU filtro ativo
    if (ev.isPast && !showPast && !hasActiveFilter) return false;
    if (fData && ev.data !== fData) return false;
    if (fAula && ev.aula !== fAula) return false;
    if (fSala && ev.sala !== fSala) return false;
    if (fNome && !ev.equipe.some(m => m.nome.toLowerCase().includes(fNome))) return false;
    return true;
  });

  // Atualiza banner s√≥ quando sem filtros
  if (!hasActiveFilter) updatePastBanner();
  else document.getElementById('pastBanner').style.display = 'none';

  if (currentView === 'cards') renderCards();
  else renderGrade();
}

function clearFilters() {
  ['filtData','filtAula','filtSala'].forEach(id => document.getElementById(id).value='');
  document.getElementById('filtNome').value = '';
  showPast = false;
  document.getElementById('togglePastBtn').classList.remove('showing-past');
  document.getElementById('togglePastLabel').textContent = 'Mostrar datas anteriores';
  applyFilters();
}

// ===================== STATS =====================
function buildStats() {
  const totalPessoas = new Set(allEvents.flatMap(e => e.equipe.map(m => m.nome.toUpperCase()))).size;
  const totalConflicts = Object.keys(conflictMap).length;
  const totalOvertime = Object.keys(overtimeMap).length;
  const totalDias = new Set(allEvents.map(e => e.data)).size;
  document.getElementById('statsBar').innerHTML = `
    <div class="stat-card"><div class="val">${allEvents.length}</div><div class="lbl">Eventos</div></div>
    <div class="stat-card"><div class="val">${totalPessoas}</div><div class="lbl">Pessoas Escaladas</div></div>
    <div class="stat-card"><div class="val">${totalDias}</div><div class="lbl">Dias na Escala</div></div>
    <div class="stat-card" style="${totalConflicts>0?'border-color:#fca5a5':''}">
      <div class="val" style="${totalConflicts>0?'color:#dc2626':''}">${totalConflicts}</div><div class="lbl">Conflitos</div></div>
    <div class="stat-card" style="${totalOvertime>0?'border-color:#fde68a':''}">
      <div class="val" style="${totalOvertime>0?'color:#d97706':''}">${totalOvertime}</div><div class="lbl">Acima 8h/dia</div></div>`;
}

// ===================== ALERTS =====================
function buildAlerts() {
  let html = '';
  const cE = Object.entries(conflictMap);
  const oE = Object.entries(overtimeMap);
  if (cE.length > 0) {
    html += `<div class="conflict-summary"><div style="font-weight:800;color:#b91c1c;margin-bottom:8px;font-size:0.84rem;">‚ö†Ô∏è CONFLITOS DE HOR√ÅRIO DETECTADOS (${cE.length} pessoa${cE.length>1?'s':''})</div>`;
    cE.forEach(([n,i]) => { html += `<div style="font-size:0.78rem;color:#991b1b;margin-bottom:4px;"><strong>${n}</strong>: ${i.join(' | ')}</div>`; });
    html += '</div>';
  }
  if (oE.length > 0) {
    html += `<div class="overtime-summary"><div style="font-weight:800;color:#92400e;margin-bottom:8px;font-size:0.84rem;">‚è±Ô∏è LIMITE DE 8H/DIA EXCEDIDO (${oE.length} pessoa${oE.length>1?'s':''})</div>`;
    oE.forEach(([n,ds]) => {
      const det = ds.map(d => `${d.data}: ${Math.floor(d.totalMin/60)}h${d.totalMin%60>0?d.totalMin%60+'min':''}`).join(' | ');
      html += `<div style="font-size:0.78rem;color:#78350f;margin-bottom:4px;"><strong>${n}</strong>: ${det}</div>`;
    });
    html += '</div>';
  }
  document.getElementById('alertsSection').innerHTML = html;
}

// ===================== BADGE HELPERS =====================
function getBadgeClass(funcao) {
  const f = funcao.toUpperCase();
  if (f.includes('COORDENADOR')) return 'badge-coordenador';
  if (f.includes('MOTORISTA'))   return 'badge-motorista';
  if (f.includes('AEROPORTO'))   return 'badge-aeroporto';
  if (f.includes('OCORR√äNCIA') || f.includes('OCORRENCIA')) return 'badge-ocorrencia';
  if (f.includes('APROXIMADO'))  return 'badge-aproximado';
  if (f.includes('VOLANTE'))     return 'badge-volante';
  if (f.includes('PROFESSOR'))   return 'badge-professor';
  if (f.includes('MONITOR SALA')) return 'badge-monitor-sala';
  if (f.includes('MONITOR'))     return 'badge-monitor';
  return 'badge-volante';
}
function getBadgeLabel(funcao) {
  const map = {
    'PROFESSOR':'Professor','MONITOR':'Monitor','PROFESSOR APROXIMADO':'Prof. Aprox.',
    'PROFESSOR OCORR√äNCIA':'Prof. Ocorr.','PROFESSOR OCORRENCIA':'Prof. Ocorr.',
    'MONITOR SALA':'Monitor Sala','MONITOR VOLANTE':'Mon. Volante',
    'PROFESSOR VOLANTE':'Prof. Volante','PROFESSOR COORDENADOR':'Coordenador',
    'PROFESSOR MOTORISTA':'Motorista','PROFESSOR AEROPORTO':'Aeroporto',
  };
  return map[funcao.toUpperCase().trim()] || funcao;
}
const BADGE_STYLES_INLINE = {
  'badge-professor':    'background:#dbeafe;color:#1d4ed8;border:1px solid #bfdbfe',
  'badge-monitor':      'background:#dcfce7;color:#15803d;border:1px solid #bbf7d0',
  'badge-aproximado':   'background:#ede9fe;color:#6d28d9;border:1px solid #ddd6fe',
  'badge-ocorrencia':   'background:#ffedd5;color:#c2410c;border:1px solid #fed7aa',
  'badge-coordenador':  'background:#fef3c7;color:#92400e;border:1px solid #fde68a',
  'badge-motorista':    'background:#cffafe;color:#0e7490;border:1px solid #a5f3fc',
  'badge-aeroporto':    'background:#fce7f3;color:#9d174d;border:1px solid #fbcfe8',
  'badge-volante':      'background:#f1f5f9;color:#475569;border:1px solid #e2e8f0',
  'badge-monitor-sala': 'background:#ccfbf1;color:#0f766e;border:1px solid #99f6e4',
};

// ===================== CARDS RENDER =====================
function renderCards() {
  const container = document.getElementById('cardsContainer');
  const empty = document.getElementById('emptyCards');
  const fNome = document.getElementById('filtNome').value.trim().toLowerCase();
  if (filteredEvents.length === 0) { container.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  const sorted = [...filteredEvents].sort((a,b) => parseDate(a.data)-parseDate(b.data) || (a.horarioStart||0)-(b.horarioStart||0));
  container.innerHTML = sorted.map(ev => {
    const evIdx = allEvents.indexOf(ev);
    const aulaName = AULA_NAMES[ev.aula] || ev.aula;
    const conflictCount = [...new Set(ev._conflicts||[])].length;
    const overtimeCount = [...new Set(ev._overtime||[])].length;
    let alertHtml = '';
    if (conflictCount>0) alertHtml += `<div class="alert-bar alert-conflict">‚ö†Ô∏è ${conflictCount} pessoa(s) com conflito de hor√°rio</div>`;
    if (overtimeCount>0) alertHtml += `<div class="alert-bar alert-overtime">‚è±Ô∏è ${overtimeCount} pessoa(s) acima de 8h/dia</div>`;
    const funcaoGroups = {};
    ev.equipe.forEach(m => { const f=m.funcao.trim().toUpperCase(); if(!funcaoGroups[f]) funcaoGroups[f]=[]; funcaoGroups[f].push(m); });
    const pessoasHtml = Object.values(funcaoGroups).map(ps => ps.map(m => {
      const isC = ev._conflicts && ev._conflicts.includes(m.nome.toUpperCase());
      const isO = ev._overtime && ev._overtime.includes(m.nome.toUpperCase());
      const hl = fNome && m.nome.toLowerCase().includes(fNome);
      return `<div class="person-row ${isC?'conflict-person':''}">
        <span class="badge ${getBadgeClass(m.funcao)}">${getBadgeLabel(m.funcao)}</span>
        <span class="person-name" style="${hl?'color:#b45309;font-weight:700;':''}">${m.nome}</span>
        ${isC?'<span title="Conflito" style="color:#dc2626;">‚ö†</span>':''}
        ${isO?'<span title="Acima 8h" style="color:#d97706;">‚è±</span>':''}
      </div>`;
    }).join('')).join('');
    const pastTag = ev.isPast ? '<span class="past-tag">üìÅ Data anterior</span>' : (ev.isToday ? '<span style="display:inline-block;margin-top:4px;padding:2px 8px;background:rgba(110,231,183,0.2);border-radius:4px;font-size:0.68rem;color:#6ee7b7;font-weight:700;">‚óè HOJE</span>' : '');
    return `<div class="aula-card ${ev._hasConflict?'has-conflict':''} ${ev._hasOvertime?'has-overtime':''} ${ev.isPast?'is-past':''}" id="card-${evIdx}">
      <div class="card-header">
        <div class="aula-code">${ev.aula}</div>
        <div class="aula-name">${aulaName}</div>
        <div class="sala">üè´ Turma: <strong>${ev.sala}</strong></div>
        <div class="horario">üïê ${ev.horarioDisplay}</div>
        ${pastTag}
        <div class="data-badge">üìÖ ${ev.data}</div>
      </div>
      <div class="card-body">${alertHtml}${pessoasHtml}</div>
      <div class="card-footer">
        <span class="count-badge">üë• ${ev.equipe.length} escalados</span>
        <button class="btn-export" onclick="exportCard(${evIdx})">üì∑ Exportar</button>
      </div>
    </div>`;
  }).join('');
}

// ===================== GRADE SEMANAL =====================
function renderGrade() {
  const table = document.getElementById('gradeTable');
  const evs = filteredEvents.length > 0 ? filteredEvents : [];
  const datas = [...new Set(evs.map(e => e.data))].sort((a,b) => parseDate(a)-parseDate(b));
  const horarios = [...new Set(evs.map(e => e.horarioStart).filter(h => h!==null))].sort((a,b) => a-b);
  if (datas.length === 0) {
    table.innerHTML = `<tr><td style="text-align:center;padding:40px;color:#94a3b8;background:#fff;border-radius:8px;">Nenhum evento para exibir</td></tr>`;
    return;
  }
  let html = '<thead><tr><th>Hor√°rio</th>';
  datas.forEach(d => {
    const dias=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
    const p=d.split('/'); const dt=new Date(parseInt(p[2]),parseInt(p[1])-1,parseInt(p[0]));
    const isPast = isDatePast(d);
    const isToday = isDateToday(d);
    const cls = isPast ? 'is-past' : (isToday ? 'is-today' : '');
    const todayTag = isToday ? ' ‚óè HOJE' : (isPast ? ' üìÅ' : '');
    html += `<th class="${cls}">${dias[dt.getDay()]}${todayTag}<br><strong>${d}</strong></th>`;
  });
  html += '</tr></thead><tbody>';
  horarios.forEach(hor => {
    const repEv = evs.find(e => e.horarioStart === hor);
    const endTime = repEv ? repEv.horarioEnd : null;
    const horLabel = endTime
      ? `<strong>${formatMin(hor)}</strong><br><span style="font-size:0.65rem;color:#94a3b8;">${formatMin(hor)} - ${formatMin(endTime)}</span>`
      : `<strong>${formatMin(hor)}</strong>`;
    html += `<tr><td class="grade-time-col">${horLabel}</td>`;
    datas.forEach(d => {
      const isPastCol = isDatePast(d);
      const cellEvs = evs.filter(e => e.data===d && e.horarioStart===hor);
      const cellHtml = cellEvs.map(ev => {
        const c = ev._hasConflict?'conflict':(ev._hasOvertime?'overtime':'');
        const idx = allEvents.indexOf(ev);
        return `<div class="grade-cell-event ${c} ${ev.isPast?'is-past':''}" onclick="openCardModal(${idx})">
          <div class="grade-event-code">${ev.aula} ‚Äî ${AULA_NAMES[ev.aula]||''}</div>
          <div class="grade-event-horario">üïê ${ev.horarioDisplay}</div>
          <div class="grade-event-sala">Turma: ${ev.sala}</div>
          <div class="grade-event-count">üë• ${ev.equipe.length} ${ev._hasConflict?'‚ö†Ô∏è':''} ${ev._hasOvertime?'‚è±Ô∏è':''}</div>
        </div>`;
      }).join('');
      html += `<td class="${isPastCol?'is-past-col':''}">${cellHtml}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody>';
  table.innerHTML = html;
}

function formatDataWeekday(d) {
  const dias=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
  const p=d.split('/'); const dt=new Date(parseInt(p[2]),parseInt(p[1])-1,parseInt(p[0]));
  return `${dias[dt.getDay()]} ${d}`;
}

// ===================== EXPORT CARD =====================
function exportCard(evIdx) {
  const ev = allEvents[evIdx];
  if (!ev) return;
  const exportDiv = document.createElement('div');
  exportDiv.style.cssText = 'width:440px;background:#fff;border:2px solid #1e3a5f;border-radius:14px;overflow:hidden;font-family:Segoe UI,system-ui,sans-serif;position:fixed;left:-9999px;top:0;';
  const funcaoGroups = {};
  ev.equipe.forEach(m => { const f=m.funcao.trim().toUpperCase(); if(!funcaoGroups[f]) funcaoGroups[f]=[]; funcaoGroups[f].push(m); });
  const pessoasHtml = Object.values(funcaoGroups).map(ps => ps.map(m => {
    const bc = getBadgeClass(m.funcao);
    const bs = BADGE_STYLES_INLINE[bc]||'';
    return `<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid #f1f5f9;">
      <span style="display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:800;${bs}">${getBadgeLabel(m.funcao)}</span>
      <span style="font-size:12px;color:#1e293b;font-weight:500;">${m.nome}</span>
    </div>`;
  }).join('')).join('');
  exportDiv.innerHTML = `
    <div style="padding:14px 18px;background:linear-gradient(135deg,#1e3a5f,#2d5a8e);border-bottom:3px solid #d4a017;">
      <div style="font-size:18px;font-weight:800;color:#fbbf24;">${ev.aula}</div>
      <div style="font-size:11px;color:#93c5fd;margin-top:2px;">${AULA_NAMES[ev.aula]||ev.aula}</div>
      <div style="font-size:13px;color:#e2e8f0;font-weight:600;margin-top:5px;">üè´ Turma: ${ev.sala}</div>
      <div style="font-size:13px;color:#bfdbfe;margin-top:3px;font-weight:600;">üïê ${ev.horarioDisplay}</div>
      <div style="font-size:12px;color:#bfdbfe;margin-top:2px;">üìÖ ${ev.data}</div>
      ${ev._hasConflict?'<div style="margin-top:8px;padding:5px 10px;background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.5);border-radius:5px;font-size:11px;color:#fca5a5;font-weight:700;">‚ö†Ô∏è Conflito de hor√°rio detectado</div>':''}
      ${ev._hasOvertime?'<div style="margin-top:6px;padding:5px 10px;background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.5);border-radius:5px;font-size:11px;color:#fde68a;font-weight:700;">‚è±Ô∏è Pessoa(s) acima de 8h/dia</div>':''}
    </div>
    <div style="padding:14px 18px;background:#fff;">
      ${pessoasHtml}
      <div style="margin-top:10px;font-size:10px;color:#94a3b8;text-align:right;padding-top:8px;border-top:1px solid #f1f5f9;">üë• ${ev.equipe.length} escalados ¬∑ Painel de Coordena√ß√£o de Curso</div>
    </div>`;
  document.body.appendChild(exportDiv);
  setTimeout(() => {
    html2canvas(exportDiv, { backgroundColor:'#ffffff', scale:2, useCORS:true }).then(canvas => {
      document.body.removeChild(exportDiv);
      const link = document.createElement('a');
      link.download = `escala_${ev.aula}_${ev.sala}_${ev.data.replace(/\//g,'-')}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }).catch(() => { document.body.removeChild(exportDiv); alert('Erro ao exportar.'); });
  }, 100);
}

// ===================== EXPORT GRADE =====================
function exportGrade() {
  const evs = filteredEvents.length > 0 ? filteredEvents : allEvents;
  if (evs.length === 0) { alert('Nenhum dado para exportar.'); return; }
  const btn = document.getElementById('btnGradeExport');
  const origText = btn.innerHTML;
  btn.innerHTML = '‚è≥ Gerando imagem...';
  btn.disabled = true;
  const datas = [...new Set(evs.map(e => e.data))].sort((a,b) => parseDate(a)-parseDate(b));
  const horarios = [...new Set(evs.map(e => e.horarioStart).filter(h => h!==null))].sort((a,b) => a-b);
  const clone = document.createElement('div');
  clone.style.cssText = 'position:fixed;left:-9999px;top:0;background:#fff;padding:20px;font-family:Segoe UI,system-ui,sans-serif;min-width:900px;';
  const hdr = document.createElement('div');
  hdr.style.cssText = 'background:linear-gradient(135deg,#1e3a5f,#2d5a8e);padding:16px 20px;border-radius:10px 10px 0 0;border-bottom:3px solid #d4a017;display:flex;align-items:center;gap:14px;';
  hdr.innerHTML = `<div style="width:40px;height:40px;background:#d4a017;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#1e3a5f;font-weight:800;">‚öñ</div>
    <div><div style="font-size:1.05rem;font-weight:800;color:#fff;">PAINEL DE COORDENA√á√ÉO ‚Äî GRADE SEMANAL</div>
    <div style="font-size:0.7rem;color:#93c5fd;margin-top:2px;text-transform:uppercase;">Escala de Professores e Monitores ¬∑ Exportado em ${new Date().toLocaleDateString('pt-BR')}</div></div>`;
  clone.appendChild(hdr);
  const fData=document.getElementById('filtData').value, fAula=document.getElementById('filtAula').value;
  const fSala=document.getElementById('filtSala').value, fNome=document.getElementById('filtNome').value.trim();
  const af=[fData&&`Data: ${fData}`,fAula&&`Aula: ${fAula}`,fSala&&`Turma: ${fSala}`,fNome&&`Nome: ${fNome}`].filter(Boolean);
  if (af.length>0) { const fb=document.createElement('div'); fb.style.cssText='background:#eff6ff;padding:8px 16px;font-size:0.75rem;color:#1d4ed8;font-weight:600;border-bottom:1px solid #bfdbfe;'; fb.textContent='üîç Filtros ativos: '+af.join(' ¬∑ '); clone.appendChild(fb); }
  const tw=document.createElement('div'); tw.style.cssText='overflow:hidden;border-radius:0 0 10px 10px;background:#e8eef5;padding:6px;';
  let tHtml=`<table style="border-collapse:separate;border-spacing:4px;width:100%;min-width:860px;"><thead><tr>
    <th style="background:#1e3a5f;padding:10px 14px;font-size:0.75rem;font-weight:800;color:#fbbf24;border-radius:6px;text-align:center;white-space:nowrap;">Hor√°rio</th>`;
  datas.forEach(d => { const past=isDatePast(d); const tod=isDateToday(d); const bg=past?'#64748b':(tod?'#065f46':'#1e3a5f'); const col=past?'#cbd5e1':(tod?'#6ee7b7':'#fbbf24'); tHtml+=`<th style="background:${bg};padding:10px 14px;font-size:0.75rem;font-weight:800;color:${col};border-radius:6px;text-align:center;white-space:nowrap;">${formatDataWeekday(d)}${tod?' ‚óè HOJE':''}</th>`; });
  tHtml+='</tr></thead><tbody>';
  horarios.forEach(hor => {
    const repEv=evs.find(e=>e.horarioStart===hor); const endTime=repEv?repEv.horarioEnd:null;
    const horLabel=endTime?`<strong>${formatMin(hor)}</strong><br><span style="font-size:9px;color:#94a3b8;">${formatMin(hor)} - ${formatMin(endTime)}</span>`:`<strong>${formatMin(hor)}</strong>`;
    tHtml+=`<tr><td style="background:#f8fafc;border:1.5px solid #d1dce8;border-radius:7px;text-align:center;font-size:0.76rem;font-weight:700;color:#64748b;padding:8px 10px;white-space:nowrap;">${horLabel}</td>`;
    datas.forEach(d => {
      const cellEvs=evs.filter(e=>e.data===d&&e.horarioStart===hor);
      const isPastCol=isDatePast(d);
      const cellBg=isPastCol?'#f8fafc':'#fff';
      const cellOpacity=isPastCol?'opacity:0.7;':'';
      let cellHtml=cellEvs.map(ev => {
        const bgStyle=ev._hasConflict?'background:linear-gradient(135deg,#fee2e2,#fff5f5);border:1.5px solid #fca5a5;':ev._hasOvertime?'background:linear-gradient(135deg,#fef9c3,#fffde7);border:1.5px solid #fde68a;':'background:linear-gradient(135deg,#dbeafe,#eff6ff);border:1.5px solid #bfdbfe;';
        const pessoasHtml=ev.equipe.map(m=>{const bc=getBadgeClass(m.funcao);const bs=BADGE_STYLES_INLINE[bc]||'';return `<div style="display:flex;align-items:center;gap:5px;padding:2px 0;"><span style="display:inline-block;padding:1px 6px;border-radius:12px;font-size:9px;font-weight:800;${bs}">${getBadgeLabel(m.funcao)}</span><span style="font-size:10px;color:#1e293b;">${m.nome}</span></div>`;}).join('');
        return `<div style="${bgStyle}border-radius:7px;padding:8px 10px;margin-bottom:4px;">
          <div style="font-size:11px;font-weight:800;color:#1e3a5f;">${ev.aula} ‚Äî ${AULA_NAMES[ev.aula]||''}</div>
          <div style="font-size:10px;color:#2d5a8e;font-weight:700;margin:1px 0 2px;">üïê ${ev.horarioDisplay}</div>
          <div style="font-size:10px;color:#64748b;margin-bottom:5px;">Turma: ${ev.sala} ${ev._hasConflict?'‚ö†Ô∏è':''} ${ev._hasOvertime?'‚è±Ô∏è':''}</div>
          ${pessoasHtml}</div>`;
      }).join('');
      tHtml+=`<td style="background:${cellBg};${cellOpacity}border:1.5px solid #d1dce8;border-radius:8px;padding:6px;vertical-align:top;min-width:130px;">${cellHtml}</td>`;
    });
    tHtml+='</tr>';
  });
  tHtml+='</tbody></table>'; tw.innerHTML=tHtml; clone.appendChild(tw);
  const footer=document.createElement('div'); footer.style.cssText='background:#f8fafc;padding:8px 16px;border-top:1px solid #d1dce8;font-size:10px;color:#94a3b8;text-align:right;'; footer.textContent=`Painel de Coordena√ß√£o de Curso ¬∑ ${allEvents.length} eventos ¬∑ ${new Set(allEvents.flatMap(e=>e.equipe.map(m=>m.nome.toUpperCase()))).size} pessoas escaladas`; clone.appendChild(footer);
  document.body.appendChild(clone);
  setTimeout(() => {
    html2canvas(clone, {backgroundColor:'#ffffff',scale:1.8,useCORS:true,logging:false}).then(canvas => {
      document.body.removeChild(clone);
      const link=document.createElement('a'); link.download=`grade_semanal_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.png`; link.href=canvas.toDataURL('image/png'); link.click();
      btn.innerHTML=origText; btn.disabled=false;
    }).catch(()=>{ document.body.removeChild(clone); btn.innerHTML=origText; btn.disabled=false; alert('Erro ao exportar grade.'); });
  }, 200);
}

// ===================== MODAL =====================
function openCardModal(evIdx) {
  const ev=allEvents[evIdx]; if(!ev) return;
  document.getElementById('modalTitle').textContent=`${ev.aula} ‚Äî ${AULA_NAMES[ev.aula]||ev.aula} | Turma: ${ev.sala}`;
  const funcaoGroups={};
  ev.equipe.forEach(m=>{const f=m.funcao.trim().toUpperCase();if(!funcaoGroups[f])funcaoGroups[f]=[];funcaoGroups[f].push(m);});
  let html=`<div style="margin-bottom:12px;font-size:0.82rem;color:#64748b;padding:8px 12px;background:#f8fafc;border-radius:7px;border:1px solid #e2e8f0;">
    üìÖ ${ev.data} ${ev.isPast?'<span style="background:#fef9c3;color:#92400e;font-size:0.7rem;padding:1px 7px;border-radius:4px;font-weight:700;margin-left:4px;">üìÅ Data anterior</span>':''} &nbsp;|&nbsp; üïê <strong>${ev.horarioDisplay}</strong> &nbsp;|&nbsp; üë• ${ev.equipe.length} escalados
  </div>`;
  if(ev._hasConflict) html+=`<div class="alert-bar alert-conflict">‚ö†Ô∏è Conflito de hor√°rio detectado</div>`;
  if(ev._hasOvertime) html+=`<div class="alert-bar alert-overtime">‚è±Ô∏è Pessoa(s) acima de 8h/dia</div>`;
  html+=Object.values(funcaoGroups).map(ps=>ps.map(m=>{
    const isC=ev._conflicts&&ev._conflicts.includes(m.nome.toUpperCase());
    const isO=ev._overtime&&ev._overtime.includes(m.nome.toUpperCase());
    return `<div class="person-row"><span class="badge ${getBadgeClass(m.funcao)}">${getBadgeLabel(m.funcao)}</span><span class="person-name">${m.nome}</span>${isC?'<span style="color:#dc2626;">‚ö†</span>':''}${isO?'<span style="color:#d97706;">‚è±</span>':''}</div>`;
  }).join('')).join('');
  html+=`<div style="margin-top:16px;text-align:right;padding-top:12px;border-top:1px solid #f1f5f9;">
    <button class="btn-export" onclick="exportCard(${evIdx})" style="padding:9px 18px;font-size:0.82rem;">üì∑ Exportar como Imagem</button>
  </div>`;
  document.getElementById('modalBody').innerHTML=html;
  document.getElementById('modalOverlay').style.display='flex';
}
function closeModal(e){if(e.target===document.getElementById('modalOverlay'))closeModalDirect();}
function closeModalDirect(){document.getElementById('modalOverlay').style.display='none';}

// ===================== VIEW SWITCH =====================
function switchView(view) {
  currentView=view;
  document.getElementById('viewCards').style.display=view==='cards'?'block':'none';
  document.getElementById('viewGrade').style.display=view==='grade'?'block':'none';
  document.getElementById('tabCards').classList.toggle('active',view==='cards');
  document.getElementById('tabGrade').classList.toggle('active',view==='grade');
  if(view==='grade') renderGrade();
}

// ===================== RESET =====================
function resetDashboard(){
  allEvents=[];filteredEvents=[];conflictMap={};overtimeMap={};showPast=false;
  document.getElementById('dashSection').style.display='none';
  document.getElementById('uploadSection').style.display='block';
  document.getElementById('csvPasteArea').value='';
  document.getElementById('statusBadge').textContent='Sem dados carregados';
  document.getElementById('statusBadge').style.cssText='font-size:0.73rem;padding:5px 12px;border-radius:20px;background:rgba(255,255,255,0.12);color:#93c5fd;font-weight:600;';
  document.getElementById('togglePastBtn').classList.remove('showing-past');
  document.getElementById('togglePastLabel').textContent='Mostrar datas anteriores';
}

// ===================== FILE INPUT =====================
document.getElementById('csvFileInput').addEventListener('change', function(e){
  const file=e.target.files[0]; if(!file) return;
  document.getElementById('loadedFileLabel').textContent='üìÑ '+file.name;
  const reader=new FileReader();
  reader.onload=ev=>processCSV(ev.target.result);
  reader.readAsText(file,'UTF-8');
  this.value='';
});
const dz=document.getElementById('dropZone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
dz.addEventListener('drop',e=>{
  e.preventDefault();dz.classList.remove('drag-over');
  const file=e.dataTransfer.files[0]; if(!file) return;
  document.getElementById('loadedFileLabel').textContent='üìÑ '+file.name;
  const reader=new FileReader();
  reader.onload=ev=>processCSV(ev.target.result);
  reader.readAsText(file,'UTF-8');
});
function processPastedCSV(){
  const text=document.getElementById('csvPasteArea').value.trim();
  if(!text){alert('√Årea de texto vazia.');return;}
  document.getElementById('loadedFileLabel').textContent='üìã CSV colado manualmente';
  processCSV(text);
}
</script>
</body>
</html>